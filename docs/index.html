<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-09-30 Thu 16:57 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ansible</title>
<meta name="author" content="VTX IT Department" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
</style>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
<div id="content" class="content">
<h1 class="title">Ansible</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org09d5667">Getting Started</a>
<ul>
<li><a href="#org51ab1ef">Install ansible on Mac</a></li>
<li><a href="#org9bd614d">Install ansible on Windows</a></li>
<li><a href="#org7027086">Clone the repository.</a></li>
</ul>
</li>
<li><a href="#orge434db4">Deploy</a></li>
<li><a href="#orgc714293">Playbooks</a>
<ul>
<li><a href="#org729fad9">Ping</a></li>
<li><a href="#orgfaddfe5">Sidekiq</a>
<ul>
<li><a href="#org2943ac8">Provision Service</a></li>
<li><a href="#orgd3038d0">Restart Sidekiq</a></li>
</ul>
</li>
<li><a href="#org555248d">Nginx Webserver</a>
<ul>
<li><a href="#org2021730">Append Nginx Configuration</a></li>
<li><a href="#org43a10ff">Restart Nginx</a></li>
</ul>
</li>
<li><a href="#orgfcdcae9">Logrotate</a></li>
<li><a href="#orgc981df5">Maintenance</a></li>
</ul>
</li>
<li><a href="#orgb4cb14c">Provision ERP</a></li>
<li><a href="#orga80f9ce">Tower</a></li>
</ul>
</div>
</div>
<p>
This repository is a collection of ansible playbooks implemented by Vertilux&rsquo;s IT dept to perform some server automations.
</p>

<div id="outline-container-org09d5667" class="outline-2">
<h2 id="org09d5667">Getting Started</h2>
<div class="outline-text-2" id="text-org09d5667">
<p>
Make sure ansible is installed on your machin, to install ansible:
</p>
</div>

<div id="outline-container-org51ab1ef" class="outline-3">
<h3 id="org51ab1ef">Install ansible on Mac</h3>
<div class="outline-text-3" id="text-org51ab1ef">
<p>
<code>brew install ansible</code>
</p>
</div>
</div>

<div id="outline-container-org9bd614d" class="outline-3">
<h3 id="org9bd614d">Install ansible on Windows</h3>
<div class="outline-text-3" id="text-org9bd614d">
<p>
Probably the best option is to installed Ubuntu on WSL (Windows Subsytem for Linux).
</p>
<ul class="org-ul">
<li>Search for Windows features in the search box. And when the “Turn Windows features on or off ” appears, click on that.</li>
<li>A window will open with a bunch of features. Scroll down and check the box of Windows Subsystem for the Linux option. And after that, click on the OK button.
<img src="windows-features.png" alt="windows-features.png" /></li>
<li>Open the Microsoft Store and search for Ubuntu to install the latest version.
<img src="microsoft-store.png" alt="microsoft-store.png" /></li>
<li>After the installation, you will see a launch button, use that to open the Ubuntu bash.</li>
<li>On Ubuntu bash, it will ask you to set the username and password for the default user. You can also set the root account password from here by typing <code>sudo passwd root</code></li>
</ul>

<p>
Now install ansible and press Y when ask for.
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #bd93f9;">sudo</span> apt-get update
<span style="color: #bd93f9;">sudo</span> apt-get install software-properties-common
<span style="color: #bd93f9;">sudo</span> apt-add-repository ppa:ansible/ansible
<span style="color: #bd93f9;">sudo</span> apt-get update
<span style="color: #bd93f9;">sudo</span> apt-get install ansible
</pre>
</div>
</div>
</div>

<div id="outline-container-org7027086" class="outline-3">
<h3 id="org7027086">Clone the repository.</h3>
<div class="outline-text-3" id="text-org7027086">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #bd93f9;">git</span> clone <span style="color: #bd93f9;">git</span>@github.com:vertilux/ansible.git
</pre>
</div>

<p>
Then cd into the ansible directory: $ <code>cd  ansible</code>
</p>
</div>
</div>
</div>

<div id="outline-container-orge434db4" class="outline-2">
<h2 id="orge434db4">Deploy</h2>
<div class="outline-text-2" id="text-orge434db4">
<p>
This playbook contains multiples roles to deploy new versions to production.
</p>
</div>
</div>

<div id="outline-container-orgc714293" class="outline-2">
<h2 id="orgc714293">Playbooks</h2>
<div class="outline-text-2" id="text-orgc714293">
<p>
A collections o simple playbooks to perform different tasks.
</p>
</div>

<div id="outline-container-org729fad9" class="outline-3">
<h3 id="org729fad9">Ping</h3>
<div class="outline-text-3" id="text-org729fad9">
<p>
Try to connect to host, verify a usable python and return <code>pong</code> on success.
</p>

<div class="org-src-container">
<pre class="src src-bash">ansible-playbook ping.yml -i inventory
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfaddfe5" class="outline-3">
<h3 id="orgfaddfe5">Sidekiq</h3>
<div class="outline-text-3" id="text-orgfaddfe5">
<p>
Background processing for ruby. Sidekiq uses threads to handle jobs at the same time in the same process. It is integrated tightly with Rails to make background processing dead simple.
</p>
</div>

<div id="outline-container-org2943ac8" class="outline-4">
<h4 id="org2943ac8">Provision Service</h4>
<div class="outline-text-4" id="text-org2943ac8">
<p>
Running sidekiq as a system service with systemd, this will ensure the process is restarted if Sidekiq crashes.
Here is an example systemd file:
</p>

<pre class="example">
[Unit]
Description=sidekiq
After=syslog.target network.target

[Service]
Type=simple
WorkingDirectory=/home/deploy/APP_LOCATION/current
ExecStart=/home/deploy/.rbenv/shims/bundle exec sidekiq -e ENVIRONMENT
User=deploy
Group=deploy
UMask=0002

# Greatly reduce Ruby memory fragmentation and heap usage
# https://www.mikeperham.com/2018/04/25/taming-rails-memory-bloat/
Environment=MALLOC_ARENA_MAX=2

# if we crash, restart
RestartSec=1
Restart=on-failure

# output goes to /var/log/syslog
StandardOutput=syslog
StandardError=syslog

# This will default to "bundler" if we don't specify it
SyslogIdentifier=sidekiq

[Install]
WantedBy=multi-user.target
</pre>

<p>
With the following playbook the service is provision on all servers.
</p>

<div class="org-src-container">
<pre class="src src-bash">ansible-playbook sidekiq_service.yml -K -i inventory.yml
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd3038d0" class="outline-4">
<h4 id="orgd3038d0">Restart Sidekiq</h4>
<div class="outline-text-4" id="text-orgd3038d0">
<div class="org-src-container">
<pre class="src src-bash">ansible-playbook restart-sidekiq.yml -K -i inventory.yml
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org555248d" class="outline-3">
<h3 id="org555248d">Nginx Webserver</h3>
<div class="outline-text-3" id="text-org555248d">
<p>
Nginx is a web server that can be used as a reverse proxy, load balancer and HTTP cache.
</p>
</div>

<div id="outline-container-org2021730" class="outline-4">
<h4 id="org2021730">Append Nginx Configuration</h4>
<div class="outline-text-4" id="text-org2021730">
<p>
This playbook will append a configuration block to the default configuration with the env passed. This is the easy way to when deploying a new distribution center.
</p>

<div class="org-src-container">
<pre class="src src-bash">ansible-playbook append-nginx-config.yml -K -i inventory.yml
</pre>
</div>
</div>
</div>

<div id="outline-container-org43a10ff" class="outline-4">
<h4 id="org43a10ff">Restart Nginx</h4>
<div class="outline-text-4" id="text-org43a10ff">
<p>
Simply restart nginx on all servers excluding load labancer.
</p>

<div class="org-src-container">
<pre class="src src-bash">ansible-playbook restart-nginx.yml -K -i inventory.yml
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgfcdcae9" class="outline-3">
<h3 id="orgfcdcae9">Logrotate</h3>
<div class="outline-text-3" id="text-orgfcdcae9">
<p>
Configuring Logrotate For Rails Production Logs.
Running <code>ansible-playbook append-logrotate.yml --extra-vars "env=ENV" -K -i inventory.yml</code> will edit <code>sudo vim /etc/logrotate.conf</code>, and at the bottom of the file the following block of code (change the ENV, ex: accltd):
</p>

<pre class="example">
/home/deploy/erp-ENV/current/log/*.log {
  daily
  missingok
  rotate 7
  compress
  delaycompress
  notifempty
  copytruncate
}
</pre>

<div class="org-src-container">
<pre class="src src-bash">ansible-playbook append-logrotate.yml -K -i inventory.yml
</pre>
</div>

<p>
<b>How it works:</b>
</p>
<ul class="org-ul">
<li>daily – Rotate the log files each day.</li>
<li>missingok – If the log file doesn’t exist, ignore it.</li>
<li>rotate 7 – Only keep 7 days of logs.</li>
<li>compress – GZip the log file on rotation.</li>
<li>delaycompress – Rotate the file one day, then compress it the next day so we can be sure that it won’t interfere with the Rails server.</li>
<li>notifempty – Don’t rotate the file if the logs are empty.</li>
<li>copytruncate – Copy the log file and then empties it.</li>
</ul>

<p>
<b>Running Logrotate:</b>
Then the playbook will run: `sudo /usr/sbin/logrotate -f /etc/logrotate.conf`
</p>
</div>
</div>

<div id="outline-container-orgc981df5" class="outline-3">
<h3 id="orgc981df5">Maintenance</h3>
<div class="outline-text-3" id="text-orgc981df5">
<p>
Sometimes there is a need to set the ERP Web application into maintenance mode; when an item change needs to be run or when the we need to upgrade Sage. For this scenarios the folloging playbook is the easier way to set all instances in maintenance mode.
</p>

<p>
Set only one distribution center to maintenance mode.
</p>
<div class="org-src-container">
<pre class="src src-bash">ansible-playbook maintenance-mode.yml -K -i inventory.yml
</pre>
</div>

<p>
Put everything into maintenance.
</p>
<div class="org-src-container">
<pre class="src src-bash">ansible-playbook maintenance-mode-all.yml -K -i inventory.yml
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-orgb4cb14c" class="outline-2">
<h2 id="orgb4cb14c">Provision ERP</h2>
<div class="outline-text-2" id="text-orgb4cb14c">
<p>
Roles to provision a new distribution center (environment) to production.
</p>
</div>
</div>

<div id="outline-container-orga80f9ce" class="outline-2">
<h2 id="orga80f9ce">Tower</h2>
<div class="outline-text-2" id="text-orga80f9ce">
<p>
A collections of playbooks to perform tasks with the tower web interface.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: VTX IT Department</p>
<p class="date">Created: 2021-09-30 Thu 16:57</p>
</div>
</body>
</html>
