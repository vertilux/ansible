<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-10-28 Thu 23:28 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ansible</title>
<meta name="author" content="VTX IT Department" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
</style>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
<div id="content" class="content">
<h1 class="title">Ansible</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org5be09b4">Getting Started</a>
<ul>
<li><a href="#orgfd3f804">Install ansible on Mac</a></li>
<li><a href="#org0ce655e">Install ansible on Windows</a></li>
<li><a href="#orgf53688a">Clone the repository.</a></li>
</ul>
</li>
<li><a href="#orgccb924f">Deploy</a>
<ul>
<li><a href="#orgd90e2dc">Entry point</a></li>
<li><a href="#orgbe7016a">Roles</a></li>
</ul>
</li>
<li><a href="#orgffdc054">Playbooks</a>
<ul>
<li><a href="#org2d3c062">Ping</a></li>
<li><a href="#org1f35b40">Sidekiq</a>
<ul>
<li><a href="#orga280afc">Provision Service</a></li>
<li><a href="#orgfc8f320">Restart Sidekiq</a></li>
</ul>
</li>
<li><a href="#org175be5a">Nginx Webserver</a>
<ul>
<li><a href="#orgbef1348">Append Nginx Configuration</a></li>
<li><a href="#org0855d62">Restart Nginx</a></li>
<li><a href="#org3d185ce">Restart passenger</a></li>
</ul>
</li>
<li><a href="#org0aab81d">Logrotate</a></li>
<li><a href="#orgfcd47a0">Maintenance</a></li>
<li><a href="#org2fccc56">Append Env Variable</a>
<ul>
<li><a href="#org54bc439">Persistent Env Variables</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org9b55a8c">Provision ERP</a>
<ul>
<li><a href="#org527bcdf">Running playbooks</a></li>
<li><a href="#org345a310">Roles</a></li>
</ul>
</li>
<li><a href="#org1c44691">Tower</a></li>
<li><a href="#orgb76ee47">Windows Management</a>
<ul>
<li><a href="#orgd7897bf">Why Automate Windows Hosts?</a></li>
<li><a href="#org8ef58cd">What’s Required?</a></li>
<li><a href="#orgd95882e">Trobleshooting WinRM</a>
<ul>
<li><a href="#orgf638f2c">Sets WinRM to Basic Authentication</a></li>
<li><a href="#org43609ed">Sets WinRM to allows unencrypted traffic</a></li>
<li><a href="#org2dee28e">Aditional Issues</a></li>
</ul>
</li>
<li><a href="#org1ef65c6">Install pywinrm</a></li>
<li><a href="#orgc04cae0">References</a></li>
<li><a href="#orgd870ca0">Playbooks</a>
<ul>
<li><a href="#org60d5b2f">Restart Granite</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgb5abc22"><span class="todo TODO">TODO</span> Ansible todo list</a></li>
</ul>
</div>
</div>
<p>
This repository is a collection of ansible playbooks implemented by Vertilux&rsquo;s IT dept to perform some server automations.
</p>

<div id="outline-container-org5be09b4" class="outline-2">
<h2 id="org5be09b4">Getting Started</h2>
<div class="outline-text-2" id="text-org5be09b4">
<p>
Make sure ansible is installed on your machin, to install ansible:
</p>
</div>

<div id="outline-container-orgfd3f804" class="outline-3">
<h3 id="orgfd3f804">Install ansible on Mac</h3>
<div class="outline-text-3" id="text-orgfd3f804">
<p>
<code>brew install ansible</code>
</p>
</div>
</div>

<div id="outline-container-org0ce655e" class="outline-3">
<h3 id="org0ce655e">Install ansible on Windows</h3>
<div class="outline-text-3" id="text-org0ce655e">
<p>
Probably the best option is to installed Ubuntu on WSL (Windows Subsytem for Linux).
</p>
<ul class="org-ul">
<li>Search for Windows features in the search box. And when the “Turn Windows features on or off ” appears, click on that.</li>
<li>A window will open with a bunch of features. Scroll down and check the box of Windows Subsystem for the Linux option. And after that, click on the OK button.
<img src="windows-features.png" alt="windows-features.png" /></li>
<li>Open the Microsoft Store and search for Ubuntu to install the latest version.
<img src="microsoft-store.png" alt="microsoft-store.png" /></li>
<li>After the installation, you will see a launch button, use that to open the Ubuntu bash.</li>
<li>On Ubuntu bash, it will ask you to set the username and password for the default user. You can also set the root account password from here by typing <code>sudo passwd root</code></li>
</ul>

<p>
Now install ansible and press Y when ask for.
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #bd93f9;">sudo</span> apt-get update
<span style="color: #bd93f9;">sudo</span> apt-get install software-properties-common
<span style="color: #bd93f9;">sudo</span> apt-add-repository ppa:ansible/ansible
<span style="color: #bd93f9;">sudo</span> apt-get update
<span style="color: #bd93f9;">sudo</span> apt-get install ansible
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf53688a" class="outline-3">
<h3 id="orgf53688a">Clone the repository.</h3>
<div class="outline-text-3" id="text-orgf53688a">
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #bd93f9;">git</span> clone <span style="color: #bd93f9;">git</span>@github.com:vertilux/ansible.git
</pre>
</div>

<p>
Then cd into the ansible directory: $ <code>cd  ansible</code>
</p>
</div>
</div>
</div>

<div id="outline-container-orgccb924f" class="outline-2">
<h2 id="orgccb924f">Deploy</h2>
<div class="outline-text-2" id="text-orgccb924f">
<p>
This playbook contains multiples roles to deploy new versions or updates to production.
</p>


<div id="orga9c7a4d" class="figure">
<p><img src="infrastructure-diagram.png" alt="infrastructure-diagram.png" />
</p>
</div>

<p>
To avoid password authetication generate a public key and copy to the remote servers.<br />
To create the SSH keys, type <code>ssh-keygen -t rsa -C "your_email@example.com"</code>. This will create both <code>id_rsa</code> and <code>id_rsa.pub</code> files.
Copy the generated public key to the remote host
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #bd93f9;">cat</span> ~/.ssh/id_rsa.pub | ssh user@remote_host <span style="color: #f1fa8c;">'</span><span style="color: #f1fa8c;">cat</span><span style="color: #f1fa8c;"> &gt;&gt; .ssh/authorized_keys'</span>
</pre>
</div>

<p>
Additioanlly disable password requirement for <code>sudo</code>.
Create a file in <code>/etc/sudoers.d/deploy</code>
</p>
<pre class="example">
deploy ALL=(ALL) NOPASSWD:ALL
</pre>
</div>

<div id="outline-container-orgd90e2dc" class="outline-3">
<h3 id="orgd90e2dc">Entry point</h3>
<div class="outline-text-3" id="text-orgd90e2dc">
<p>
This playbook execute the different roles that will run
</p>

<div class="org-src-container">
<pre class="src src-bash">ansible-playbook entry_point.yml -i inventory
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbe7016a" class="outline-3">
<h3 id="orgbe7016a">Roles</h3>
<div class="outline-text-3" id="text-orgbe7016a">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">description</th>
<th scope="col" class="org-left">commands</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">app-update</td>
<td class="org-left">Will check if directory exist then is going to clone or pull from version control (Github)</td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left"><code>yarn install</code></td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left"><code>bundle</code></td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left"><code>RAILS_ENV={{env}} rake assets:precompile</code></td>
</tr>

<tr>
<td class="org-left">run-migrations</td>
<td class="org-left"><code>RAILS_ENV={{env}} rake db:migrat</code></td>
</tr>

<tr>
<td class="org-left">restart-sidekiq</td>
<td class="org-left"><code>sudo service sidekiq-{{env}} restart</code></td>
</tr>

<tr>
<td class="org-left">restart-nginx</td>
<td class="org-left"><code>sudo service sidekiq-{{env}} restart</code></td>
</tr>

<tr>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<div id="outline-container-orgffdc054" class="outline-2">
<h2 id="orgffdc054">Playbooks</h2>
<div class="outline-text-2" id="text-orgffdc054">
<p>
A collections o simple playbooks to perform different tasks.
</p>
</div>

<div id="outline-container-org2d3c062" class="outline-3">
<h3 id="org2d3c062">Ping</h3>
<div class="outline-text-3" id="text-org2d3c062">
<p>
Try to connect to host, verify a usable python and return <code>pong</code> on success.
</p>

<div class="org-src-container">
<pre class="src src-bash">ansible-playbook ping.yml -i inventory
</pre>
</div>
</div>
</div>

<div id="outline-container-org1f35b40" class="outline-3">
<h3 id="org1f35b40">Sidekiq</h3>
<div class="outline-text-3" id="text-org1f35b40">
<p>
Background processing for ruby. Sidekiq uses threads to handle jobs at the same time in the same process. It is integrated tightly with Rails to make background processing dead simple.
</p>
</div>

<div id="outline-container-orga280afc" class="outline-4">
<h4 id="orga280afc">Provision Service</h4>
<div class="outline-text-4" id="text-orga280afc">
<p>
Running sidekiq as a system service with systemd, this will ensure the process is restarted if Sidekiq crashes.
Here is an example systemd file:
</p>

<pre class="example">
[Unit]
Description=sidekiq
After=syslog.target network.target

[Service]
Type=simple
WorkingDirectory=/home/deploy/APP_LOCATION/current
ExecStart=/home/deploy/.rbenv/shims/bundle exec sidekiq -e ENVIRONMENT
User=deploy
Group=deploy
UMask=0002

# Greatly reduce Ruby memory fragmentation and heap usage
# https://www.mikeperham.com/2018/04/25/taming-rails-memory-bloat/
Environment=MALLOC_ARENA_MAX=2

# if we crash, restart
RestartSec=1
Restart=on-failure

# output goes to /var/log/syslog
StandardOutput=syslog
StandardError=syslog

# This will default to "bundler" if we don't specify it
SyslogIdentifier=sidekiq

[Install]
WantedBy=multi-user.target
</pre>

<p>
With the following playbook the service is provision on all servers.
</p>

<div class="org-src-container">
<pre class="src src-bash">ansible-playbook sidekiq_service.yml -K -i inventory.yml
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfc8f320" class="outline-4">
<h4 id="orgfc8f320">Restart Sidekiq</h4>
<div class="outline-text-4" id="text-orgfc8f320">
<div class="org-src-container">
<pre class="src src-bash">ansible-playbook restart-sidekiq.yml -K -i inventory.yml
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org175be5a" class="outline-3">
<h3 id="org175be5a">Nginx Webserver</h3>
<div class="outline-text-3" id="text-org175be5a">
<p>
Nginx is a web server that can be used as a reverse proxy, load balancer and HTTP cache.
</p>
</div>

<div id="outline-container-orgbef1348" class="outline-4">
<h4 id="orgbef1348">Append Nginx Configuration</h4>
<div class="outline-text-4" id="text-orgbef1348">
<p>
This playbook will append a configuration block to the default configuration with the env passed. This is the easy way to when deploying a new distribution center.
</p>

<div class="org-src-container">
<pre class="src src-bash">ansible-playbook append-nginx-config.yml -K -i inventory.yml
</pre>
</div>
</div>
</div>

<div id="outline-container-org0855d62" class="outline-4">
<h4 id="org0855d62">Restart Nginx</h4>
<div class="outline-text-4" id="text-org0855d62">
<p>
Simply restart nginx on all servers excluding load labancer.
</p>

<div class="org-src-container">
<pre class="src src-bash">ansible-playbook restart-nginx.yml -K -i inventory.yml
</pre>
</div>
</div>
</div>

<div id="outline-container-org3d185ce" class="outline-4">
<h4 id="org3d185ce">Restart passenger</h4>
<div class="outline-text-4" id="text-org3d185ce">
<p>
Phusion Passenger is an open source web application server. It handles HTTP requests, manages processes and resources, and enables administration, monitoring and problem diagnosis.
</p>

<div class="org-src-container">
<pre class="src src-bash">ansible-playbook restart-passenger.yml -i inventory.yml
</pre>
</div>

<p>
This playbook displays a prompt to enter the environment to be restarted, with this option you can restart only one environment (distribution center app).
</p>
</div>
</div>
</div>

<div id="outline-container-org0aab81d" class="outline-3">
<h3 id="org0aab81d">Logrotate</h3>
<div class="outline-text-3" id="text-org0aab81d">
<p>
Configuring Logrotate For Rails Production Logs.
Running <code>ansible-playbook append-logrotate.yml --extra-vars "env=ENV" -K -i inventory.yml</code> will edit <code>sudo vim /etc/logrotate.conf</code>, and at the bottom of the file the following block of code (change the ENV, ex: accltd):
</p>

<pre class="example">
/home/deploy/erp-ENV/current/log/*.log {
  daily
  missingok
  rotate 7
  compress
  delaycompress
  notifempty
  copytruncate
}
</pre>

<div class="org-src-container">
<pre class="src src-bash">ansible-playbook append-logrotate.yml -K -i inventory.yml
</pre>
</div>

<p>
<b>How it works:</b>
</p>
<ul class="org-ul">
<li>daily – Rotate the log files each day.</li>
<li>missingok – If the log file doesn’t exist, ignore it.</li>
<li>rotate 7 – Only keep 7 days of logs.</li>
<li>compress – GZip the log file on rotation.</li>
<li>delaycompress – Rotate the file one day, then compress it the next day so we can be sure that it won’t interfere with the Rails server.</li>
<li>notifempty – Don’t rotate the file if the logs are empty.</li>
<li>copytruncate – Copy the log file and then empties it.</li>
</ul>

<p>
<b>Running Logrotate:</b>
Then the playbook will run: `sudo /usr/sbin/logrotate -f /etc/logrotate.conf`
</p>
</div>
</div>

<div id="outline-container-orgfcd47a0" class="outline-3">
<h3 id="orgfcd47a0">Maintenance</h3>
<div class="outline-text-3" id="text-orgfcd47a0">
<p>
Sometimes there is a need to set the ERP Web application into maintenance mode; when an item change needs to be run or when the we need to upgrade Sage. For this scenarios the folloging playbook is the easier way to set all instances in maintenance mode.
</p>

<p>
Set only one distribution center to maintenance mode.
</p>
<div class="org-src-container">
<pre class="src src-bash">ansible-playbook maintenance-mode.yml -K -i inventory.yml
</pre>
</div>

<p>
Put everything into maintenance.
</p>
<div class="org-src-container">
<pre class="src src-bash">ansible-playbook maintenance-mode-all.yml -K -i inventory.yml
</pre>
</div>
</div>
</div>

<div id="outline-container-org2fccc56" class="outline-3">
<h3 id="org2fccc56">Append Env Variable</h3>
<div class="outline-text-3" id="text-org2fccc56">
<p>
Environment variables are a set of dynamic named values, stored within the system that are used by applications launched. In simple words, an environment variable is a variable with a name and an associated value.
</p>
</div>

<div id="outline-container-org54bc439" class="outline-4">
<h4 id="org54bc439">Persistent Env Variables</h4>
<div class="outline-text-4" id="text-org54bc439">
<p>
To make Environment variables persistent you need to define those variables in the bash configuration files. In most Linux distributions when you start a new session, environment variables are read from the following files:
</p>

<ul class="org-ul">
<li><p>
<code>/etc/environment</code>: Use this file to set up system-wide environment variables. Variables in this file are set in the following format:
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #ffc9e8;">FOO</span>=bar
<span style="color: #ffc9e8;">VAR_TEST</span>=<span style="color: #f1fa8c;">"Test Var"</span>
</pre>
</div></li>

<li><p>
<code>/etc/profile</code>: Variables set in this file are loaded whenever a bash login shell is entered. When declaring environment variables in this file you need to use the export command:
</p>
<div class="org-src-container">
<pre class="src src-bash"><span style="color: #ffb86c;">export</span> <span style="color: #ffc9e8;">FOO</span>=<span style="color: #f1fa8c;">"bar"</span>
<span style="color: #ffb86c;">export</span> <span style="color: #ffc9e8;">VAR_TEST</span>=<span style="color: #f1fa8c;">"Test Bar"</span>
</pre>
</div></li>
</ul>

<p>
For our apps we used <code>/etc/profile</code>, to add (append) a new env variables just need to run the following playbook:
</p>
<div class="org-src-container">
<pre class="src src-bash">ansible-playbook append-env-variable.yml -K -i inventory.yml
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org9b55a8c" class="outline-2">
<h2 id="org9b55a8c">Provision ERP</h2>
<div class="outline-text-2" id="text-org9b55a8c">
<p>
Provision ERP is a collection of ansibles roles to make easy the setup of multiples environments. Every environemnt is a distribution center, this approach makes us use the same code for all distribution centers and easy to maintain.
</p>
</div>

<div id="outline-container-org527bcdf" class="outline-3">
<h3 id="org527bcdf">Running playbooks</h3>
<div class="outline-text-3" id="text-org527bcdf">
<div class="org-src-container">
<pre class="src src-bash">ansible-playbook entry_point.yml -i inventory.yml -k -K
</pre>
</div>

<p>
Entry point is the <code>main</code> playbook, this is going to ask for:
</p>
<ul class="org-ul">
<li>User name.</li>
<li>Environment (Sage300 SQL server name lowecase).</li>
<li>URL (DNS url for the application, Ex: erp.vertilux.com).</li>
<li>Port (SQL server port set on firewall rule).</li>
</ul>
</div>
</div>

<div id="outline-container-org345a310" class="outline-3">
<h3 id="org345a310">Roles</h3>
<div class="outline-text-3" id="text-org345a310">
<ul class="org-ul">
<li>set-config-files</li>
<li>append-nginx-config</li>
<li>set-sidekiq-service</li>
<li>logrotate</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org1c44691" class="outline-2">
<h2 id="org1c44691">Tower</h2>
<div class="outline-text-2" id="text-org1c44691">
<p>
A collections of playbooks to perform tasks with the tower web interface.
</p>
</div>
</div>
<div id="outline-container-orgb76ee47" class="outline-2">
<h2 id="orgb76ee47">Windows Management</h2>
<div class="outline-text-2" id="text-orgb76ee47">
<p>
Ansible Windows module uses winrm connection, in order to execute commands in the Windows machine.
</p>
</div>

<div id="outline-container-orgd7897bf" class="outline-3">
<h3 id="orgd7897bf">Why Automate Windows Hosts?</h3>
<div class="outline-text-3" id="text-orgd7897bf">
<p>
A few of the many things you can do for your Windows hosts with Ansible.Windows include:
</p>
<ul class="org-ul">
<li>Starting, stopping and managing services</li>
<li>Pushing &amp; executing custom PowerShell scripts</li>
<li>Reboot multiples machines simultaneously</li>
</ul>

<p>
For a complete list of Ansible.Windows modules visit this <a href="https://docs.ansible.com/ansible/latest/collections/ansible/windows/index.html">link</a>.
</p>
</div>
</div>

<div id="outline-container-org8ef58cd" class="outline-3">
<h3 id="org8ef58cd">What’s Required?</h3>
<div class="outline-text-3" id="text-org8ef58cd">
<p>
First, the control machine (where Ansible will be executing your Windows modules from) needs to run Linux. Second, Windows support has been evolving rapidly, so make sure to use the newest possible version of Ansible to get the latest features!
</p>

<p>
For the target hosts, you should be running at least Windows 7 SP1 or later or Windows Server 2008 SP1 or later.
</p>

<p>
Lastly, since Ansible connects to Windows machines and runs PowerShell scripts by using Windows Remote Management (WinRM) (as an alternative to SSH for Linux/Unix machines), make WinRM is activated.
</p>
</div>
</div>

<div id="outline-container-orgd95882e" class="outline-3">
<h3 id="orgd95882e">Trobleshooting WinRM</h3>
<div class="outline-text-3" id="text-orgd95882e">
<p>
Sometimes we get an error <code>plaintext: the specified credentials were rejected by the server</code> and the reason it’s not the credentials as I know they are correct. It must be some other authentication issue.
</p>

<p>
The problem is that it is sending credentials in plaintext over the unencrypted WinRM port 5985. The fix is a couple of WinRM configuration changes in the Windows servers. In an elevated command prompt type the following commands:
</p>
</div>

<div id="outline-container-orgf638f2c" class="outline-4">
<h4 id="orgf638f2c">Sets WinRM to Basic Authentication</h4>
<div class="outline-text-4" id="text-orgf638f2c">
<div class="org-src-container">
<pre class="src src-PowerShell">winrm set winrm/config/service/auth '@{Basic="true"}'
</pre>
</div>

<pre class="example" id="org9e9e9ad">
Auth
    Basic = true
    Kerberos = true
    Negotiate = true
    Certificate = false
    CredSSP = false
    CbtHardeningLevel = Relaxed
</pre>
</div>
</div>

<div id="outline-container-org43609ed" class="outline-4">
<h4 id="org43609ed">Sets WinRM to allows unencrypted traffic</h4>
<div class="outline-text-4" id="text-org43609ed">
<div class="org-src-container">
<pre class="src src-PowerShell">winrm set winrm/config/service '@{AllowUnencrypted="true"}'
</pre>
</div>

<pre class="example" id="org3e76d13">
Service
    RootSDDL = O:NSG:BAD:P(A;;GA;;;BA)(A;;GR;;;IU)S:P(AU;FA;GA;;;WD)(AU;SA;GXGW;;;WD)
    MaxConcurrentOperations = 4294967295
    MaxConcurrentOperationsPerUser = 1500
    EnumerationTimeoutms = 240000
    MaxConnections = 300
    MaxPacketRetrievalTimeSeconds = 120
    AllowUnencrypted = true
    Auth
        Basic = true
        Kerberos = true
        Negotiate = true
        Certificate = false
        CredSSP = false
        CbtHardeningLevel = Relaxed
    DefaultPorts
        HTTP = 5985
        HTTPS = 5986
    IPv4Filter = *
    IPv6Filter = *
    EnableCompatibilityHttpListener = false
    EnableCompatibilityHttpsListener = false
    CertificateThumbprint
    AllowRemoteAccess = true
</pre>
</div>
</div>

<div id="outline-container-org2dee28e" class="outline-4">
<h4 id="org2dee28e">Aditional Issues</h4>
<div class="outline-text-4" id="text-org2dee28e">
<p>
Because WinRM can be configured in so many different ways, errors that seem Ansible related can actually be due to problems with host setup instead.<br />
Some examples of WinRM errors that you might see include:
</p>

<ul class="org-ul">
<li>HTTP 401 error</li>
<li>HTTP 500 error</li>
<li>Timeout issues</li>
<li>Connection refusal.</li>
</ul>

<p>
Visit the <a href="https://docs.ansible.com/ansible/devel/user_guide/windows_setup.html?extIdCarryOver=true&amp;sc_cid=7013a000002pemAAAQ#common-winrm-issues">Common WinRM Issues</a> section of our Ansible.Windows Setup documentation page.
</p>
</div>
</div>
</div>

<div id="outline-container-org1ef65c6" class="outline-3">
<h3 id="org1ef65c6">Install pywinrm</h3>
<div class="outline-text-3" id="text-org1ef65c6">
<p>
<code>pywinrm</code> dependencies aren’t shipped by default with Ansible, make sure you install the <code>pywinrm</code> library on the machine that Ansible is installed on. The simplest method is to run:
</p>

<div class="org-src-container">
<pre class="src src-bash">pip install pywinrm
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc04cae0" class="outline-3">
<h3 id="orgc04cae0">References</h3>
<div class="outline-text-3" id="text-orgc04cae0">
<ul class="org-ul">
<li><a href="https://www.ansible.com/blog">The Inside Playbook</a></li>
<li><a href="https://docs.ansible.com/ansible/devel/user_guide/windows_setup.html">Ansible Documentation</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgd870ca0" class="outline-3">
<h3 id="orgd870ca0">Playbooks</h3>
<div class="outline-text-3" id="text-orgd870ca0">
</div>
<div id="outline-container-org60d5b2f" class="outline-4">
<h4 id="org60d5b2f">Restart Granite</h4>
<div class="outline-text-4" id="text-org60d5b2f">
<p>
This playbbok wil use <code>win_service</code> – Manage and query Windows services to restart a chosen Granite service. For beter UX select an <code>application (country or distribution center)</code> from the prompt menu.
</p>

<div class="org-src-container">
<pre class="src src-bash">ansible-playbook restart-granite-services.yml -i inventor
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb5abc22" class="outline-2">
<h2 id="orgb5abc22"><span class="todo TODO">TODO</span> Ansible todo list</h2>
<div class="outline-text-2" id="text-orgb5abc22">
<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> Create a bash script to group and execute playbooks</li>
<li class="off"><code>[&#xa0;]</code> Extend windows module</li>
<li class="off"><code>[&#xa0;]</code> Refector ERP playbooks</li>
<li class="off"><code>[&#xa0;]</code> Separate ERP playbooks from non-ERP</li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: VTX IT Department</p>
<p class="date">Created: 2021-10-28 Thu 23:28</p>
</div>
</body>
</html>
