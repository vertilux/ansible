---
- name: "ERP Vertilux - Reindex Elasticsearch (Searchkick)"
  hosts: all
  become: yes
  become_user: deploy
  gather_facts: yes
  # GARANTÍA: Ejecuta solo en 1 servidor.
  run_once: true

  tasks:
    # 1. Normalización
    - name: "1. Normalizar código de compañía"
      set_fact:
        clean_tenant: >-
          {%- if tenant_code is string -%}
          {{ tenant_code }}
          {%- elif tenant_code is sequence and tenant_code | length > 0 -%}
          {{ tenant_code[0] }}
          {%- else -%}
          ''
          {%- endif -%}

    # 2. Validación
    - name: "2. Validar datos de entrada"
      fail:
        msg: "ERROR: Faltan datos. Asegúrese de seleccionar Compañía y Clase en el Survey."
      when: 
        - clean_tenant == '' or clean_tenant is undefined
        - target_class is undefined or target_class == ''

    # 3. Configuración
    - name: "3. Configurar entorno de ejecución"
      set_fact:
        app: "erp-{{ clean_tenant }}"
        env: "{{ clean_tenant }}"
        class_to_reindex: "{{ target_class }}"

    # --- HOTFIXES DE INGENIERÍA: REEMPLAZO QUIRÚRGICO (RUBY) ---
    # En lugar de usar SED (que falló por sintaxis), usamos un script Ruby para reescribir
    # el método 'search_data' completo. Esto garantiza código limpio y sanitizado.
    - name: "3.5 Hotfix: Reescribir método search_data (Ruby Script)"
      shell: |
        cat <<'RUBYEOF' > patch_shipping_reference.rb
        file_path = 'app/models/shipping_reference.rb'
        content = File.read(file_path)

        # Definimos el método 100% limpio y seguro (sin errores de sintaxis)
        # Incluye las protecciones: find_by/try (para IDs huérfanos) y .to_s.squish (para saltos de línea)
        safe_method = <<~METHOD
          def search_data
            {
              id: id,
              number: number,
              customer_id: customer_field,
              customer_namer: Granite::Document.where(TradingPartnerCode: customer).pluck(:TradingPartnerDescription).first.to_s.squish,
              location: location,
              shipvia: shipvia,
              type: ShippingReferenceType.find_by(id: shipping_reference_type_id).try(:name),
              granite_document: Granite::Document.where('"ID" IN (?)', granite_document).pluck(:Number).map(&:to_s).map(&:squish),
              user_id: user_id,
              user_name: User.find_by(id: user_id).try(:fname),
              status: status,
              created_at: created_at,
              updated_at: updated_at
            }
          end
        METHOD

        # Expresión regular para encontrar el bloque 'def search_data ... end' original
        # Busca desde 'def search_data' hasta el 'end' que cierra el método.
        regex = /^\s*def search_data\s*$.*?^\s*end\s*$/m

        if content.match?(regex)
          # Reemplazamos el bloque viejo (o roto) con el nuevo bloque seguro
          new_content = content.sub(regex, safe_method.strip.gsub(/^/, '  ')) 
          File.write(file_path, new_content)
          puts "PATCH SUCCESS: search_data method overwritten cleanly."
        else
          # Fallback: Si el regex no casa (archivo muy modificado), verificamos si ya tiene el código seguro
          if content.include?("first.to_s.squish") && content.include?("map(&:squish)")
            puts "PATCH SKIP: File already secure."
          else
            puts "PATCH WARNING: Could not find method block to replace."
          end
        end
        RUBYEOF

        # Ejecutamos el parche usando el entorno Ruby de la app
        export PATH="/home/deploy/.rbenv/bin:/home/deploy/.rbenv/shims:$PATH"
        eval "$(rbenv init -)"
        ruby patch_shipping_reference.rb
      args:
        chdir: "/home/deploy/{{ app }}/current"
      # Solo ejecutamos esto si la clase es ShippingReference
      when: class_to_reindex == 'ShippingReference'

    # 4. EJECUCIÓN (Super Segura: BATCH 50 + UTF-8)
    - name: "4. Reindexing {{ class_to_reindex }} for {{ env }}"
      command: >-
        /bin/bash -l -c 'cd /home/deploy/{{app}}/current && bundle exec rake RAILS_ENV={{env}} searchkick:reindex CLASS={{class_to_reindex}} BATCH=50'
      environment:
        PATH: "/home/deploy/.rbenv/plugins/ruby-build/bin:/home/deploy/.rbenv/bin:/home/deploy/.rbenv/plugins/ruby-build/bin:/home/deploy/.rbenv/shims:/home/deploy/.rbenv/bin:/usr/local/sbin:/usr/local/bin:/usr/local/sbin:/usr/bin:/sbin:/bin:/usr/games"
        LC_ALL: "en_US.UTF-8"
        LANG: "en_US.UTF-8"
      register: reindex_result

    - name: "5. Resultado Final"
      debug:
        msg: "{{ reindex_result.stdout_lines }}"
