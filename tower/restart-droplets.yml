# Play 2: reiniciar serial=1 con manejo de errores sin detener todo
- name: Sequentially reboot selected droplets
  hosts: reboot_batch
  gather_facts: false
  serial: 1
  vars:
    slack_webhook_url: "{{ SLACK_WEBHOOK_URL | default('') }}"
  tasks:
    - name: Announce per-droplet start
      when: slack_webhook_url | length > 0
      uri:
        url: "{{ slack_webhook_url }}"
        method: POST
        headers: { Content-Type: "application/json" }
        body_format: json
        body:
          text: "üîÑ Rebooting *{{ inventory_hostname }}* ({{ ansible_host }})‚Ä¶"
      changed_when: false
      ignore_errors: true

    - block:
        # Intento principal: m√≥dulo reboot
        - name: Attempt controlled reboot
          become: true
          become_method: sudo
          reboot:
            reboot_timeout: 180
            test_command: "uptime"
          register: reboot_main
          ignore_errors: true

        # Fallback si falla el reboot module
        - name: Fallback reboot using shutdown (async)
          when: reboot_main is failed
          shell: "nohup /usr/bin/sudo /sbin/shutdown -r now >/dev/null 2>&1 &"
          async: 1
          poll: 0
          register: reboot_fallback
          ignore_errors: true

        # Espera 15 segundos antes de verificar
        - name: Wait short grace period before checking return
          pause:
            seconds: 15

        # Espera que vuelva
        - name: Wait for droplet to come back online
          wait_for_connection:
            delay: 10
            timeout: 120
          register: back_up
          ignore_errors: true

      rescue:
        - name: Mark reboot as failed
          set_fact:
            droplet_ok: false
      always:
        - name: Evaluate result even if failed
          set_fact:
            droplet_ok: >-
              {{ (reboot_main is defined and reboot_main is succeeded)
                 or (back_up is defined and back_up is succeeded)
                 or false }}

        - name: Send per-droplet status to Slack
          when: slack_webhook_url | length > 0
          uri:
            url: "{{ slack_webhook_url }}"
            method: POST
            headers: { Content-Type: "application/json" }
            body_format: json
            body: >-
              {% if droplet_ok %}
              {"text":"‚úÖ *{{ inventory_hostname }}* rebooted successfully ({{ ansible_host }})."}
              {% else %}
              {"text":"‚ùå *{{ inventory_hostname }}* reboot failed or could not complete ({{ ansible_host }})."}
              {% endif %}
          changed_when: false
          ignore_errors: true

        - name: Pause before next droplet
          pause:
            seconds: 15
