---
- hosts: all
  gather_facts: no
  vars:
    # Variables de seguridad que se esperan como 'Extra Variables' en AWX/Ansible Tower
    aws_access_key: "{{ aws_access_key }}"
    aws_secret_key: "{{ aws_secret_key }}"
    bucket: "{{ bucket }}"
    slack_token: "{{ slack_token }}"
    
    # Lista fija de compa√±√≠as (sites) a sincronizar
    companies:
      - erp-accltd
      - erp-bzidat
      - erp-espdat
      - erp-mxpdat
      - erp-pwcdat
      - erp-rdmdat
      - erp-saldat
      - erp-covdat
      - erp-prndat
      - erp-wepdat

  tasks:
    # 1. Iterar sobre cada compa√±√≠a y sincronizar los archivos con AWS S3
    - name: Synchronize sales analysis files for each company to AWS S3
      loop: "{{ companies }}"
      loop_control:
        loop_var: current_site
      block:
        - name: Upload files for site {{ current_site }}
          ansible.builtin.s3_sync:
            aws_access_key: '{{ aws_access_key }}'
            aws_secret_key: '{{ aws_secret_key }}'
            bucket: '{{ bucket }}'
            region: 'us-east-1'
            # Ruta de origen din√°mica
            file_root: "/home/deploy/{{ current_site }}/current/public/json/"
            # Prefijo S3 din√°mico para organizar por compa√±√≠a
            key_prefix: "json/{{ current_site }}"
            permission: public-read
            include: "*"
          ignore_errors: yes
          register: s3_result

        # 2. Notificaci√≥n de Slack solo si falla la sincronizaci√≥n de una compa√±√≠a
        - name: Send FAILED notification for site {{ current_site }} via Slack
          community.general.slack:
            token: '{{ slack_token }}'
            color: danger
            msg: "üö® Sales analysis synchronization **FAILED** for company **{{ current_site }}** (AWS S3)."
          when: s3_result.failed

- hosts: localhost # Ejecutar la notificaci√≥n final localmente desde AWX/Tower
  tasks:
    # 3. Notificaci√≥n final de Slack de √âxito General
    - name: Send SUCCESS/COMPLETION notification via Slack
      community.general.slack:
        token: '{{ slack_token }}'
        color: good
        msg: '‚úÖ Sales analysis files successfully synchronized for **all companies** to AWS S3.'
