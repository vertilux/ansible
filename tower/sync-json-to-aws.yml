---
- hosts: all
  gather_facts: no
  vars:
    # Variables de seguridad que se esperan como 'Extra Variables' en AWX/Ansible Tower
    aws_access_key: "{{ aws_access_key }}"
    aws_secret_key: "{{ aws_secret_key }}"
    bucket: "{{ bucket }}"
    slack_token: "{{ slack_token }}"
    # Se inicializa una lista de fallos
    sync_failures: []
    
    # Lista fija de compaÃ±Ã­as (sites) a sincronizar
    companies:
      - erp-accltd
      - erp-bzidat
      - erp-espdat
      - erp-mxpdat
      - erp-pwcdat
      - erp-rdmdat
      - erp-saldat
      - erp-covdat
      - erp-prndat
      - erp-wepdat

  tasks:
    # 1. Tarea de sincronizaciÃ³n: MÃ³dulo corregido a community.aws.s3_sync
    - name: ðŸ”„ S3 Sync | Upload files for each site
      community.aws.s3_sync:  # <-- Â¡NOMBRE DEL MÃ“DULO CORREGIDO AQUÃ!
        aws_access_key: '{{ aws_access_key }}'
        aws_secret_key: '{{ aws_secret_key }}'
        bucket: '{{ bucket }}'
        region: 'us-east-1'
        # Ruta de origen dinÃ¡mica
        file_root: "/home/deploy/{{ item }}/current/public/json/"
        # Prefijo S3 dinÃ¡mico
        key_prefix: "json/{{ item }}"
        permission: public-read
        include: "*"
      loop: "{{ companies }}" 
      ignore_errors: yes
      register: s3_results
    
    # 2. Agregar compaÃ±Ã­as fallidas a una lista 
    - name: ðŸ“ Log failed synchronizations
      set_fact:
        sync_failures: "{{ sync_failures + [item.item] }}"
      loop: "{{ s3_results.results }}"
      when: item.failed
    
    # 3. NotificaciÃ³n de Slack solo si hubo fallas
    - name: ðŸš¨ Send FAILED notification for all failed sites via Slack
      community.general.slack:
        token: '{{ slack_token }}'
        color: danger
        msg: |
          ðŸš¨ Sales analysis synchronization **FAILED** on one or more sites (AWS S3).
          Failed sites: **{{ sync_failures | join(', ') }}**
      run_once: true
      when: sync_failures | length > 0

# SEGUNDO PLAY: NotificaciÃ³n final de Ã©xito (se ejecuta si el primer play no tuvo errores fatales)

- hosts: localhost 
  tasks:
    # 4. NotificaciÃ³n final de Ã©xito 
    - name: âœ… Send SUCCESS/COMPLETION notification via Slack
      community.general.slack:
        token: '{{ slack_token }}'
        color: good
        msg: 'âœ… Sales analysis files successfully synchronized ({{ companies | length }} attempts) to AWS S3.'
