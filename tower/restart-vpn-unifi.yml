---
- name: Restart selected VPNs on Miami UDM (via SSH + API)
  hosts: localhost
  gather_facts: no

  vars:
    udm_ip: "10.255.255.1"
    vpn_map:
      PHILLY-GU: "67a26b268580e74ffc0ffc40"
      VTX_SPAIN: "68891f59ccb180797a4bb5e6"
      VXCALUDM: "67cee99c8580e74ffc44c64f"
      VXDLLUDM: "67a26bfa8580e74ffc0ffded"
      VXPANUDM: "67ceeb598580e74ffc44c971"

  tasks:

    - name: Confirm VPNs selected in survey
      assert:
        that:
          - survey_vpn | length > 0
        success_msg: "✅ Selected VPNs: {{ survey_vpn }}"
        fail_msg: "❌ No VPNs selected."

    - name: Notify start on Slack
      ansible.builtin.uri:
        url: "{{ slack_webhook_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          text: "⚙️ Starting VPN restart process on *Miami UDM* for: {{ survey_vpn | join(', ') }}"
      ignore_errors: true

    - name: Restart each selected VPN
      loop: "{{ survey_vpn }}"
      loop_control:
        loop_var: vpn_name
      block:

        - name: Disable VPN {{ vpn_name }}
          ansible.builtin.shell: >
            curl -sk -X PUT
            -H 'Content-Type: application/json'
            -H 'X-API-KEY: {{ unifi_api_key }}'
            -d '{"enabled": false}'
            https://127.0.0.1/proxy/network/api/s/default/rest/networkconf/{{ vpn_map[vpn_name] }}
          delegate_to: "{{ udm_ip }}"
          remote_user: root

        - name: Wait 30 seconds before re-enabling {{ vpn_name }}
          ansible.builtin.pause:
            seconds: 30

        - name: Enable VPN {{ vpn_name }}
          ansible.builtin.shell: >
            curl -sk -X PUT
            -H 'Content-Type: application/json'
            -H 'X-API-KEY: {{ unifi_api_key }}'
            -d '{"enabled": true}'
            https://127.0.0.1/proxy/network/api/s/default/rest/networkconf/{{ vpn_map[vpn_name] }}
          delegate_to: "{{ udm_ip }}"
          remote_user: root

        - name: Send Slack notification for {{ vpn_name }}
          ansible.builtin.uri:
            url: "{{ slack_webhook_url }}"
            method: POST
            headers:
              Content-Type: "application/json"
            body_format: json
            body:
              text: "✅ VPN *{{ vpn_name }}* has been successfully restarted on *Miami UDM*."
          ignore_errors: true

    - name: Final Slack summary
      ansible.builtin.uri:
        url: "{{ slack_webhook_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          text: "🎯 VPN restart completed for: {{ survey_vpn | join(', ') }}"
      ignore_errors: true
