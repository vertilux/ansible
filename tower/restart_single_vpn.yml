---
- name: Disable VPN {{ vpn_name }}
  ansible.builtin.shell: >
    curl -sk -X PUT
    -H 'Content-Type: application/json'
    -H 'X-API-KEY: {{ unifi_api_key }}'
    -d '{"enabled": false}'
    https://127.0.0.1/proxy/network/api/s/default/rest/networkconf/{{ vpn_map[vpn_name] }}
  delegate_to: "{{ udm_ip }}"
  remote_user: root

- name: Wait 30 seconds before re-enabling {{ vpn_name }}
  ansible.builtin.pause:
    seconds: 30

- name: Enable VPN {{ vpn_name }}
  ansible.builtin.shell: >
    curl -sk -X PUT
    -H 'Content-Type: application/json'
    -H 'X-API-KEY: {{ unifi_api_key }}'
    -d '{"enabled": true}'
    https://127.0.0.1/proxy/network/api/s/default/rest/networkconf/{{ vpn_map[vpn_name] }}
  delegate_to: "{{ udm_ip }}"
  remote_user: root

- name: Notify Slack for {{ vpn_name }}
  ansible.builtin.uri:
    url: "{{ SLACK_WEBHOOK_URL }}"
    method: POST
    headers:
      Content-Type: "application/json"
    body_format: json
    body:
      text: "âœ… VPN *{{ vpn_name }}* has been successfully restarted on *Miami UDM*."
  ignore_errors: true
