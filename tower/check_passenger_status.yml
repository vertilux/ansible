---
- name: Monitor Passenger queue and send snapshot
  hosts: app_servers
  serial: 1
  gather_facts: yes
  become: yes

  vars:
    queue_threshold: 10
    slack_webhook_url: "{{ SLACK_WEBHOOK_URL | default('') }}"

  tasks:

    # --- QUEUE ---
    - name: Read Passenger queue
      command: passenger-status
      register: queue_raw
      changed_when: false

    - name: Parse queue value (cast to INT)
      set_fact:
        queue_size: "{{ queue_raw.stdout
                        | regex_search('Requests in top-level queue\\s*:\\s*(\\d+)', '\\1')
                        | int }}"

    # --- EXTRA SNAPSHOT INFO ---
    - name: Get passenger memory stats
      command: passenger-memory-stats
      register: memstats_raw
      changed_when: false

    - name: Get free memory
      command: free -h
      register: free_raw
      changed_when: false

    # --- BUILD SUMMARY ---
    - name: Build Slack summary message
      set_fact:
        slack_message: |
          ðŸ–¥ï¸ *Snapshot â€” {{ inventory_hostname }}*
          â€¢ Queue: `{{ queue_size }}`
          â€¢ Threshold: `{{ queue_threshold }}`

          *Memory (free -h)*:
          ```
          {{ free_raw.stdout }}
          ```

          *Passenger memory stats*:
          ```
          {{ memstats_raw.stdout }}
          ```

    # --- SEND SUMMARY ---
    - name: Send Slack snapshot
      when: slack_webhook_url | length > 0
      uri:
        url: "{{ slack_webhook_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          text: "{{ slack_message }}"
      changed_when: false
      ignore_errors: true
