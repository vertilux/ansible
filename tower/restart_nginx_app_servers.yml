---
# Play 1: Build nginx host list and announce start
- name: Build nginx batch and announce start
  hosts: localhost
  gather_facts: no

  vars:
    slack_webhook_url: "{{ SLACK_WEBHOOK_URL | default('') }}"
    start_epoch: "{{ lookup('pipe', 'date +%s') }}"

    app_servers:
      production-lb01: 165.227.210.87
      production-lb02: 159.203.94.161
      production-lb03: 134.209.34.218
      production-lb04: 134.209.34.40

  tasks:

    - name: Create transient group nginx_batch
      add_host:
        name: "{{ item.key }}"
        ansible_host: "{{ item.value }}"
        groups: nginx_batch
      loop: "{{ app_servers | dict2items }}"

    - name: Notify start on Slack
      when: slack_webhook_url | length > 0
      uri:
        url: "{{ slack_webhook_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          text: "âš™ï¸ Starting sequential *NGINX restart* on: {{ app_servers.keys() | join(', ') }}"
      changed_when: false
      ignore_errors: true

    - name: Share values for other plays
      set_stats:
        data:
          nginx_start_epoch: "{{ start_epoch }}"
          slack_url_shared: "{{ slack_webhook_url }}"

# Play 2 â€” restart sequentially
- name: Restart nginx sequentially
  hosts: nginx_batch
  gather_facts: false
  serial: 1
  become: yes

  vars:
    slack_webhook_url: "{{ hostvars['localhost']['slack_url_shared'] | default('') }}"

  tasks:

    - name: Notify Slack before restart
      when: slack_webhook_url | length > 0
      uri:
        url: "{{ slack_webhook_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          text: "ðŸ”„ Restarting nginx on *{{ inventory_hostname }}* ({{ ansible_host }})..."
      changed_when: false
      ignore_errors: true

    - name: Restart nginx service
      ansible.builtin.systemd:
        name: nginx
        state: restarted
        daemon_reload: yes
      register: nginx_result
      ignore_errors: true

    - pause:
        seconds: 2

    - name: Notify Slack after restart
      when: slack_webhook_url | length > 0
      uri:
        url: "{{ slack_webhook_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body: >-
          {% if nginx_result is succeeded %}
          {"text":"âœ… NGINX restarted successfully on *{{ inventory_hostname }}*"}
          {% else %}
          {"text":"âŒ NGINX restart FAILED on *{{ inventory_hostname }}*"}
          {% endif %}
      changed_when: false
      ignore_errors: true

# Play 3 â€” final message
- name: Final Slack message
  hosts: localhost
  gather_facts: no

  vars:
    slack_webhook_url: "{{ hostvars['localhost']['slack_url_shared'] | default('') }}"

  tasks:

    - name: Notify completion
      when: slack_webhook_url | length > 0
      uri:
        url: "{{ slack_webhook_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          text: "ðŸŽ¯ Finished NGINX restart batch."
      changed_when: false
      ignore_errors: true
