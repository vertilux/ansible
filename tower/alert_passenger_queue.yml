---
- name: Monitor Passenger queue and alert if high
  hosts: production-lb03
  gather_facts: yes
  become: yes

  vars:
    queue_threshold: 10
    slack_webhook_url: "{{ SLACK_WEBHOOK_URL | default('') }}"

  tasks:

    - name: Show server current hour
      debug:
        msg: "Server hour is {{ ansible_date_time.hour }}"

    - name: Read Passenger queue
      command: passenger-status
      register: queue_raw

    - name: Parse queue value (cast to INT)
      set_fact:
        queue_size: "{{ (queue_raw.stdout | regex_search('Requests in top-level queue\\s*:\\s*(\\d+)', '\\1')) | int }}"

    - name: Debug queue value
      debug:
        msg: "ðŸ‘‰ Passenger queue on {{ inventory_hostname }} = {{ queue_size }}"

    - name: Send Slack alert if queue is high
      when: queue_size > queue_threshold
      uri:
        url: "{{ slack_webhook_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          text: |
            ðŸš¨ *Passenger queue alert*
            Host: {{ inventory_hostname }}
            Queue: {{ queue_size }}  (threshold: {{ queue_threshold }})
      changed_when: false
      ignore_errors: true
