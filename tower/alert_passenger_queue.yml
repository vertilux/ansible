---
- name: Monitor Passenger queue and alert if high
  hosts: app_servers
  gather_facts: yes
  become: yes
  serial: 1

  vars:
    slack_webhook_url: "{{ hostvars['localhost']['slack_url_shared'] | default(lookup('env','SLACK_WEBHOOK_URL') | default('', true)) }}"
    queue_threshold: 10
    start_hour: 11
    end_hour: 16

  tasks:

    - name: Show server current hour
      debug:
        msg: "Server hour is {{ ansible_date_time.hour }}"

    - name: Skip outside monitoring window
      when: (ansible_date_time.hour | int) < start_hour
            or (ansible_date_time.hour | int) >= end_hour
      debug:
        msg: "â¸ï¸ Outside monitoring window ({{ start_hour }}â€“{{ end_hour }}). Skipping."
      changed_when: false

    - name: Read Passenger queue (only during window)
      when: (ansible_date_time.hour | int) >= start_hour
            and (ansible_date_time.hour | int) < end_hour
      command: passenger-status --show=xml
      register: passenger_xml
      changed_when: false

    - name: Parse queue value
      when: passenger_xml.stdout is defined
      set_fact:
        queue_size: "{{ (passenger_xml.stdout | regex_search('<get_wait_list_size>([0-9]+)</get_wait_list_size>', '\\1')) | first | int }}"

    - name: Debug queue value
      debug:
        msg: "Queue on {{ inventory_hostname }} = {{ queue_size | default('unknown') }}"

    - name: Send Slack alert if queue high
      when:
        - slack_webhook_url | length > 0
        - queue_size is defined
        - queue_size | int > queue_threshold
      uri:
        url: "{{ slack_webhook_url }}"
        method: POST
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          text: >-
            ðŸš¨ *Passenger queue alert*\n
            Host: `{{ inventory_hostname }}`\n
            Queue: *{{ queue_size }}* (threshold {{ queue_threshold }})\n
            Time: {{ ansible_date_time.time }}
      changed_when: false
      ignore_errors: true
