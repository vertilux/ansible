---
- name: "ERP Vertilux - Reindex Elasticsearch (Searchkick)"
  hosts: all
  become: yes
  become_user: deploy
  gather_facts: yes
  # Ejecuta solo en 1 servidor para no sobrecargar el cluster de Elastic
  run_once: true

  tasks:
    # PASO CRÍTICO: Normalización de variables
    # Detectamos la variable cruda (sea tenant_code o tenant_selection)
    - name: "0. Detectar variable cruda"
      set_fact:
        raw_input: "{{ tenant_code | default(tenant_selection) | default('') }}"

    # CORRECCIÓN: Si AWX envía una lista ['pwcdat'] en lugar de un texto 'pwcdat',
    # extraemos el primer elemento para evitar errores en la ruta del directorio.
    - name: "0.1 Normalizar dato (Lista -> Texto)"
      set_fact:
        actual_tenant: >-
          {%- if raw_input is string -%}
          {{ raw_input }}
          {%- elif raw_input is sequence and raw_input | length > 0 -%}
          {{ raw_input[0] }}
          {%- else -%}
          ''
          {%- endif -%}

    - name: "1. Validar recepción de datos"
      fail:
        msg: "ERROR: No se recibió el código de la compañía. Verifica que el Survey en AWX esté en ON y que la variable se llame 'tenant_code' o 'tenant_selection'."
      when: actual_tenant == '' or actual_tenant is undefined

    - name: "2. Configurar rutas dinámicas"
      set_fact:
        # Construye la ruta basada en la evidencia: /home/deploy/erp-pwcdat/current
        app_base_path: "/home/deploy/erp-{{ actual_tenant }}/current"
        # El RAILS_ENV es el mismo código del tenant (ej. pwcdat)
        rails_env_name: "{{ actual_tenant }}"

    - name: "3. Validar que el directorio existe en el servidor"
      stat:
        path: "{{ app_base_path }}"
      register: dir_check

    - name: "4. Detener si la carpeta no existe (Seguridad)"
      fail:
        msg: "El directorio {{ app_base_path }} no existe en el servidor {{ inventory_hostname }}. Verifica que el código '{{ actual_tenant }}' sea correcto."
      when: not dir_check.stat.exists

    - name: "5. Confirmar inicio de tarea"
      debug:
        msg: "Iniciando reindexación para: {{ rails_env_name }} en {{ app_base_path }}"

    # Ejecutamos el reindex usando el entorno de rbenv y bundle exec
    - name: "6. Ejecutar Rake Task: searchkick:reindex:all"
      shell: |
        export RAILS_ENV={{ rails_env_name }}
        export PATH="/home/deploy/.rbenv/bin:/home/deploy/.rbenv/shims:$PATH"
        eval "$(rbenv init -)"
        bundle exec rake searchkick:reindex:all
      args:
        chdir: "{{ app_base_path }}"
      async: 1800 # 30 minutos de timeout
      poll: 15
      register: reindex_result

    - name: "7. Resultado de la Reindexación"
      debug:
        msg: "{{ reindex_result.stdout_lines }}"
