---
- name: Upload all company JSON analysis files to AWS S3
  hosts: app_servers
  become: yes
  gather_facts: no
  serial: 1

  vars:
    region: "us-east-1"
    json_root: "/home/deploy"
    companies:
      - erp-accltd
      - erp-bzidat
      - erp-espdat
      - erp-mxpdat
      - erp-pwcdat
      - erp-rdmdat
      - erp-saldat
      - erp-covdat
      - erp-prndat
      - erp-wepdat

  tasks:

    - name: Skip non-primary node (only run on production-lb04)
      meta: end_host
      when: inventory_hostname != "production-lb04"

    - name: Upload all JSON files for each company to AWS S3
      amazon.aws.s3_sync:
        aws_access_key: "{{ aws_access_key }}"
        aws_secret_key: "{{ aws_secret_key }}"
        bucket: "{{ bucket }}"
        region: "{{ region }}"
        file_root: "{{ json_root }}/{{ item }}/current/public/json/"
        key_prefix: "json/{{ item }}"
        permission: public-read
        include: "*.json"
      loop: "{{ companies }}"
      ignore_errors: yes
      register: upload_result

    - name: Send Slack notification on failure
      when: upload_result.failed
      community.general.slack:
        token: "{{ slack_token }}"
        color: danger
        msg: ":x: JSON sync to AWS S3 failed for one or more companies."

    - name: Send Slack notification on success
      when: not upload_result.failed
      community.general.slack:
        token: "{{ slack_token }}"
        color: good
        msg: ":white_check_mark: JSON files successfully synchronized to AWS S3."
